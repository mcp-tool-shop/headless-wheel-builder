name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      target:
        description: 'Publish target'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi
      dry_run:
        description: 'Dry run (build only, no publish)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12"

permissions:
  contents: read
  id-token: write  # Required for trusted publishing
  attestations: write  # Required for artifact attestations

jobs:
  # ==========================================================================
  # Build Package
  # ==========================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      wheel_name: ${{ steps.build.outputs.wheel_name }}
      sdist_name: ${{ steps.build.outputs.sdist_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: pip install build twine hatchling

      - name: Extract version
        id: version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION"

      - name: Build package
        id: build
        run: |
          python -m build
          WHEEL_NAME=$(ls dist/*.whl | head -1 | xargs basename)
          SDIST_NAME=$(ls dist/*.tar.gz | head -1 | xargs basename)
          echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
          echo "sdist_name=$SDIST_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Built: $WHEEL_NAME"
          echo "ðŸ“¦ Built: $SDIST_NAME"

      - name: Check package metadata
        run: |
          twine check dist/*
          echo "âœ… Package metadata validated"

      - name: Verify package contents
        run: |
          pip install dist/*.whl
          python -c "import headless_wheel_builder; print(f'Version: {headless_wheel_builder.__version__}')"
          python -c "from headless_wheel_builder.cli.main import cli; print('CLI loaded successfully')"
          # Verify new modules are included
          python -c "from headless_wheel_builder.pipeline import Pipeline; print('Pipeline module OK')"
          python -c "from headless_wheel_builder.release import ReleaseManager; print('Release module OK')"
          python -c "from headless_wheel_builder.depgraph import DependencyAnalyzer; print('Depgraph module OK')"
          echo "âœ… Package verification passed"

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-py environment -o sbom.json --format json
          echo "âœ… SBOM generated"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  # ==========================================================================
  # Run Tests on Built Package
  # ==========================================================================
  test-package:
    name: Test Package
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install package
        run: pip install dist/*.whl

      - name: Install test dependencies
        run: pip install pytest pytest-asyncio pytest-mock

      - name: Run smoke tests
        run: |
          python -c "import headless_wheel_builder; print(headless_wheel_builder.__version__)"
          hwb --version
          hwb --help

      - name: Run unit tests
        run: pytest tests/unit/ -v --tb=short

  # ==========================================================================
  # Security Scan
  # ==========================================================================
  security-scan:
    name: Security Scan
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install security tools
        run: pip install safety bandit pip-audit

      - name: Install package
        run: pip install dist/*.whl

      - name: Run pip-audit
        run: pip-audit --strict --desc on
        continue-on-error: true

      - name: Run bandit on source
        run: bandit -r src/ -ll
        continue-on-error: true

      - name: Summary
        run: echo "âœ… Security scan completed"

  # ==========================================================================
  # Publish to TestPyPI
  # ==========================================================================
  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build, test-package]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.target == 'testpypi' &&
      github.event.inputs.dry_run != 'true'
    environment:
      name: testpypi
      url: https://test.pypi.org/project/headless-wheel-builder/
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true

      - name: Verify installation from TestPyPI
        run: |
          sleep 30  # Wait for package to be available
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ headless-wheel-builder==${{ needs.build.outputs.version }}
          hwb --version
          echo "âœ… TestPyPI verification passed"

  # ==========================================================================
  # Publish to PyPI
  # ==========================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: [build, test-package, security-scan]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'release') ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.target == 'pypi' &&
       github.event.inputs.dry_run != 'true')
    environment:
      name: pypi
      url: https://pypi.org/project/headless-wheel-builder/
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Verify installation from PyPI
        run: |
          sleep 60  # Wait for package to be available
          pip install headless-wheel-builder==${{ needs.build.outputs.version }}
          hwb --version
          echo "âœ… PyPI verification passed"

  # ==========================================================================
  # Create GitHub Release Assets
  # ==========================================================================
  release-assets:
    name: Upload Release Assets
    needs: [build, publish-pypi]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: .

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            sbom.json

  # ==========================================================================
  # Notify on Completion
  # ==========================================================================
  notify:
    name: Notify
    needs: [build, publish-pypi]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'release'
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“¦ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Wheel**: ${{ needs.build.outputs.wheel_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: ${{ needs.build.outputs.sdist_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI](https://pypi.org/project/headless-wheel-builder/${{ needs.build.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://github.com/mcp-tool-shop/headless-wheel-builder#readme)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Install" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install headless-wheel-builder==${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
